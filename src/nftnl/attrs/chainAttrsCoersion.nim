import macros
import ../autogenerated/generated_nftnl
import ../raii/basics
import ../contracts/chain

# --- raw API
# ------------------------------------------------------

proc rawSetAttr*(c: ptr struct_nftnl_chain, attr: uint16, v: string) =
  discard nftnl_chain_set_str(c, attr, cast[ptr uint8](v.cstring))

proc rawSetAttr*(c: ptr struct_nftnl_chain, attr: uint16, v: uint32) =
  nftnl_chain_set_u32(c, attr, v)

proc rawSetAttr*(c: ptr struct_nftnl_chain, attr: uint16, v: uint64) =
  nftnl_chain_set_u64(c, attr, v)

# --- Coercion
# ------------------------------------------------------

proc rawGetAttr*[T](c: ptr struct_nftnl_chain, attr: uint16): T =
  when T is string:
    $cast[cstring](nftnl_chain_get_str(c, attr))
  elif T is uint32:
    nftnl_chain_get_u32(c, attr)
  elif T is uint64:
    nftnl_chain_get_u64(c, attr)
  else:
    {.error: "Unsupported type for rawGetAttr".}

proc rawSetAttr*[T](c: ptr struct_nftnl_chain, attr: uint16, v: T) =
  when T is string:
    rawSetAttr(c, attr, v)
  elif T is SomeInteger: # handle int-like
    when sizeof(T) <= 4:
      rawSetAttr(c, attr, v.uint32)
    else:
      rawSetAttr(c, attr, v.uint64)
  elif T is enum: # <-- NEW
    when sizeof(ord(v)) <= 4:
      rawSetAttr(c, attr, ord(v).uint32)
    else:
      rawSetAttr(c, attr, ord(v).uint64)
  elif T is uint32:
    rawSetAttr(c, attr, v)
  elif T is uint64:
    rawSetAttr(c, attr, v)
  else:
    {.error: "Unsupported type for rawSetAttrTyped".}

# --- le macro
# ------------------------------------------------------

macro attrOp*(c: typed, attr: enum_nftnl_chain_attr, args: varargs[untyped]): untyped =
  if args.len == 0:
    result = quote:
      rawGetAttr[expectedType(`attr`)](`c`.raw, `attr`.uint16)
  elif args.len == 1:
    let arg0 = args[0]
    result = quote:
      rawSetAttr(`c`.raw, `attr`.uint16, `arg0`)
  else:
    error("attrOp takes 0 or 1 extra arguments")

# --- convenience wrappers -----------------------------------------------------

template setAttr*(c: Chain, attr: enum_nftnl_chain_attr, val: untyped): untyped =
  attrOp(c, attr, val)

template getAttr*(c: Chain, attr: enum_nftnl_chain_attr): untyped =
  attrOp(c, attr)
