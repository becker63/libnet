# src/linux/generator.nim
{.passC: staticExec("pkg-config --cflags libnftnl").}
{.passL: staticExec("pkg-config --libs   libnftnl").}

from os import parentDir, `/`
import futhark, os

when defined(useFuthark):
  const
    glibcInclude = staticExec("nix eval --raw nixpkgs#glibc.dev.outPath") & "/include"
    linuxHeadersInclude =
      staticExec("nix build --no-link --print-out-paths nixpkgs#linuxHeaders") &
      "/include"

    outDir = currentSourcePath.parentDir / "autogenerated"
    outFile = outDir / "generated_linux.nim"

  static:
    if not dirExists(outDir):
      createDir(outDir)

  importc:
    outputPath outFile.string

    # Add both libc + kernel headers
    path glibcInclude
    path linuxHeadersInclude

    "linux/socket.h"
    "sys/socket.h"
    "linux/netlink.h"
    "linux/netfilter.h" # <--- now present in linuxHeaders
    "linux/netfilter/nf_tables.h"
    "linux/netfilter/nfnetlink.h"
    "linux/netfilter_ipv4.h"
    "linux/netfilter_ipv6.h"
